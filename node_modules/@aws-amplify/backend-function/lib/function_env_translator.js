import { Arn, Lazy, Stack } from 'aws-cdk-lib';
import { Effect, PolicyStatement } from 'aws-cdk-lib/aws-iam';
/**
 * Translates function environment props into appropriate environment records and builds a policy statement
 * in order to resolve secrets in environment props.
 */
export class FunctionEnvironmentTranslator {
    lambda;
    functionEnvironmentProp;
    backendSecretResolver;
    ssmPaths = [];
    ssmEnvVars = {};
    amplifySsmEnvConfigKey = 'AMPLIFY_SSM_ENV_CONFIG';
    ssmValuePlaceholderText = '<value will be resolved during runtime>';
    /**
     * Initialize translated environment variable records
     */
    constructor(lambda, // we need to use a specific type here so that we have all the method goodies
    functionEnvironmentProp, backendSecretResolver) {
        this.lambda = lambda;
        this.functionEnvironmentProp = functionEnvironmentProp;
        this.backendSecretResolver = backendSecretResolver;
        for (const [key, value] of Object.entries(this.functionEnvironmentProp)) {
            if (key === this.amplifySsmEnvConfigKey) {
                throw new Error(`${this.amplifySsmEnvConfigKey} is a reserved environment variable name`);
            }
            if (typeof value !== 'string') {
                const { branchSecretPath, sharedSecretPath } = this.backendSecretResolver.resolvePath(value);
                this.lambda.addEnvironment(key, this.ssmValuePlaceholderText);
                this.ssmEnvVars[branchSecretPath] = {
                    name: key,
                    sharedPath: sharedSecretPath,
                };
                this.ssmPaths.push(branchSecretPath, sharedSecretPath);
            }
            else {
                this.lambda.addEnvironment(key, value);
            }
        }
        // add an environment variable for ssm parameter metadata that is resolved after initialization but before synth is finalized
        this.lambda.addEnvironment(this.amplifySsmEnvConfigKey, Lazy.string({
            produce: () => JSON.stringify(this.ssmEnvVars),
        }));
        this.lambda.node.addValidation({
            validate: () => {
                // only add the ssm access policy if there are ssm paths
                if (this.ssmPaths.length > 0) {
                    const ssmAccessPolicy = new PolicyStatement({
                        effect: Effect.ALLOW,
                        actions: ['ssm:GetParameters'],
                        resources: this.ssmPaths
                            .map((path) => (path.startsWith('/') ? path.slice(1) : path)) // the Arn formatter will add a leading slash between the resource and resourceName
                            .map((path) => Arn.format({
                            service: 'ssm',
                            resource: 'parameter',
                            resourceName: path,
                        }, Stack.of(this.lambda))),
                    });
                    this.lambda.grantPrincipal.addToPrincipalPolicy(ssmAccessPolicy);
                }
                return [];
            },
        });
    }
    /**
     * Adds an environment variable to the lambda whose value will be fetched from SSM at runtime
     * @param name The environment variable name
     * @param ssmPath The SSM path where the value is stored
     */
    addSsmEnvironmentEntry = (name, ssmPath) => {
        this.lambda.addEnvironment(name, this.ssmValuePlaceholderText);
        this.ssmPaths.push(ssmPath);
        this.ssmEnvVars[ssmPath] = { name };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRy9DLE9BQU8sRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFOUQ7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLDZCQUE2QjtJQVlyQjtJQUNBO0lBQ0E7SUFiRixRQUFRLEdBQWEsRUFBRSxDQUFDO0lBQ3hCLFVBQVUsR0FBZSxFQUFFLENBQUM7SUFFNUIsc0JBQXNCLEdBQUcsd0JBQXdCLENBQUM7SUFDbEQsdUJBQXVCLEdBQ3RDLHlDQUF5QyxDQUFDO0lBRTVDOztPQUVHO0lBQ0gsWUFDbUIsTUFBc0IsRUFBRSw2RUFBNkU7SUFDckcsdUJBQStELEVBQy9ELHFCQUE0QztRQUY1QyxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXdDO1FBQy9ELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFFN0QsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEVBQUU7WUFDdkUsSUFBSSxHQUFHLEtBQUssSUFBSSxDQUFDLHNCQUFzQixFQUFFO2dCQUN2QyxNQUFNLElBQUksS0FBSyxDQUNiLEdBQUcsSUFBSSxDQUFDLHNCQUFzQiwwQ0FBMEMsQ0FDekUsQ0FBQzthQUNIO1lBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7Z0JBQzdCLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxHQUMxQyxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7Z0JBQzlELElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsR0FBRztvQkFDbEMsSUFBSSxFQUFFLEdBQUc7b0JBQ1QsVUFBVSxFQUFFLGdCQUFnQjtpQkFDN0IsQ0FBQztnQkFDRixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2FBQ3hEO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUN4QztTQUNGO1FBRUQsNkhBQTZIO1FBQzdILElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUN4QixJQUFJLENBQUMsc0JBQXNCLEVBQzNCLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDVixPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1NBQy9DLENBQUMsQ0FDSCxDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQzdCLFFBQVEsRUFBRSxHQUFHLEVBQUU7Z0JBQ2Isd0RBQXdEO2dCQUN4RCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDNUIsTUFBTSxlQUFlLEdBQUcsSUFBSSxlQUFlLENBQUM7d0JBQzFDLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSzt3QkFDcEIsT0FBTyxFQUFFLENBQUMsbUJBQW1CLENBQUM7d0JBQzlCLFNBQVMsRUFBRSxJQUFJLENBQUMsUUFBUTs2QkFDckIsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsbUZBQW1GOzZCQUNoSixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNaLEdBQUcsQ0FBQyxNQUFNLENBQ1I7NEJBQ0UsT0FBTyxFQUFFLEtBQUs7NEJBQ2QsUUFBUSxFQUFFLFdBQVc7NEJBQ3JCLFlBQVksRUFBRSxJQUFJO3lCQUNuQixFQUNELEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUN0QixDQUNGO3FCQUNKLENBQUMsQ0FBQztvQkFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztpQkFDbEU7Z0JBQ0QsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxzQkFBc0IsR0FBRyxDQUFDLElBQVksRUFBRSxPQUFlLEVBQUUsRUFBRTtRQUN6RCxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3RDLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFja2VuZFNlY3JldFJlc29sdmVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBcm4sIExhenksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgRnVuY3Rpb25Qcm9wcyB9IGZyb20gJy4vZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5cbi8qKlxuICogVHJhbnNsYXRlcyBmdW5jdGlvbiBlbnZpcm9ubWVudCBwcm9wcyBpbnRvIGFwcHJvcHJpYXRlIGVudmlyb25tZW50IHJlY29yZHMgYW5kIGJ1aWxkcyBhIHBvbGljeSBzdGF0ZW1lbnRcbiAqIGluIG9yZGVyIHRvIHJlc29sdmUgc2VjcmV0cyBpbiBlbnZpcm9ubWVudCBwcm9wcy5cbiAqL1xuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzc21QYXRoczogc3RyaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBzc21FbnZWYXJzOiBTc21FbnZWYXJzID0ge307XG5cbiAgcHJpdmF0ZSByZWFkb25seSBhbXBsaWZ5U3NtRW52Q29uZmlnS2V5ID0gJ0FNUExJRllfU1NNX0VOVl9DT05GSUcnO1xuICBwcml2YXRlIHJlYWRvbmx5IHNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0ID1cbiAgICAnPHZhbHVlIHdpbGwgYmUgcmVzb2x2ZWQgZHVyaW5nIHJ1bnRpbWU+JztcblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0cmFuc2xhdGVkIGVudmlyb25tZW50IHZhcmlhYmxlIHJlY29yZHNcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbGFtYmRhOiBOb2RlanNGdW5jdGlvbiwgLy8gd2UgbmVlZCB0byB1c2UgYSBzcGVjaWZpYyB0eXBlIGhlcmUgc28gdGhhdCB3ZSBoYXZlIGFsbCB0aGUgbWV0aG9kIGdvb2RpZXNcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uRW52aXJvbm1lbnRQcm9wOiBSZXF1aXJlZDxGdW5jdGlvblByb3BzPlsnZW52aXJvbm1lbnQnXSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyXG4gICkge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFByb3ApKSB7XG4gICAgICBpZiAoa2V5ID09PSB0aGlzLmFtcGxpZnlTc21FbnZDb25maWdLZXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGAke3RoaXMuYW1wbGlmeVNzbUVudkNvbmZpZ0tleX0gaXMgYSByZXNlcnZlZCBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgeyBicmFuY2hTZWNyZXRQYXRoLCBzaGFyZWRTZWNyZXRQYXRoIH0gPVxuICAgICAgICAgIHRoaXMuYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgICAgdGhpcy5sYW1iZGEuYWRkRW52aXJvbm1lbnQoa2V5LCB0aGlzLnNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0KTtcbiAgICAgICAgdGhpcy5zc21FbnZWYXJzW2JyYW5jaFNlY3JldFBhdGhdID0ge1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBzaGFyZWRQYXRoOiBzaGFyZWRTZWNyZXRQYXRoLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNzbVBhdGhzLnB1c2goYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxhbWJkYS5hZGRFbnZpcm9ubWVudChrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBhZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgZm9yIHNzbSBwYXJhbWV0ZXIgbWV0YWRhdGEgdGhhdCBpcyByZXNvbHZlZCBhZnRlciBpbml0aWFsaXphdGlvbiBidXQgYmVmb3JlIHN5bnRoIGlzIGZpbmFsaXplZFxuICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KFxuICAgICAgdGhpcy5hbXBsaWZ5U3NtRW52Q29uZmlnS2V5LFxuICAgICAgTGF6eS5zdHJpbmcoe1xuICAgICAgICBwcm9kdWNlOiAoKSA9PiBKU09OLnN0cmluZ2lmeSh0aGlzLnNzbUVudlZhcnMpLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgdGhpcy5sYW1iZGEubm9kZS5hZGRWYWxpZGF0aW9uKHtcbiAgICAgIHZhbGlkYXRlOiAoKSA9PiB7XG4gICAgICAgIC8vIG9ubHkgYWRkIHRoZSBzc20gYWNjZXNzIHBvbGljeSBpZiB0aGVyZSBhcmUgc3NtIHBhdGhzXG4gICAgICAgIGlmICh0aGlzLnNzbVBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBzc21BY2Nlc3NQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgYWN0aW9uczogWydzc206R2V0UGFyYW1ldGVycyddLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiB0aGlzLnNzbVBhdGhzXG4gICAgICAgICAgICAgIC5tYXAoKHBhdGgpID0+IChwYXRoLnN0YXJ0c1dpdGgoJy8nKSA/IHBhdGguc2xpY2UoMSkgOiBwYXRoKSkgLy8gdGhlIEFybiBmb3JtYXR0ZXIgd2lsbCBhZGQgYSBsZWFkaW5nIHNsYXNoIGJldHdlZW4gdGhlIHJlc291cmNlIGFuZCByZXNvdXJjZU5hbWVcbiAgICAgICAgICAgICAgLm1hcCgocGF0aCkgPT5cbiAgICAgICAgICAgICAgICBBcm4uZm9ybWF0KFxuICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiAnc3NtJyxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2U6ICdwYXJhbWV0ZXInLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZU5hbWU6IHBhdGgsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgU3RhY2sub2YodGhpcy5sYW1iZGEpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMubGFtYmRhLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KHNzbUFjY2Vzc1BvbGljeSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFuIGVudmlyb25tZW50IHZhcmlhYmxlIHRvIHRoZSBsYW1iZGEgd2hvc2UgdmFsdWUgd2lsbCBiZSBmZXRjaGVkIGZyb20gU1NNIGF0IHJ1bnRpbWVcbiAgICogQHBhcmFtIG5hbWUgVGhlIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVcbiAgICogQHBhcmFtIHNzbVBhdGggVGhlIFNTTSBwYXRoIHdoZXJlIHRoZSB2YWx1ZSBpcyBzdG9yZWRcbiAgICovXG4gIGFkZFNzbUVudmlyb25tZW50RW50cnkgPSAobmFtZTogc3RyaW5nLCBzc21QYXRoOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLmxhbWJkYS5hZGRFbnZpcm9ubWVudChuYW1lLCB0aGlzLnNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0KTtcbiAgICB0aGlzLnNzbVBhdGhzLnB1c2goc3NtUGF0aCk7XG4gICAgdGhpcy5zc21FbnZWYXJzW3NzbVBhdGhdID0geyBuYW1lIH07XG4gIH07XG59XG5cbi8qKlxuICogRGVmaW5lcyBtZXRhZGF0YSBhcm91bmQgZW52aXJvbm1lbnQgdmFyaWFibGUgdmFsdWVzIHRoYXQgYXJlIGZldGNoZWQgZnJvbSBTU00gZHVyaW5nIHJ1bnRpbWUgb2YgdGhlIGxhbWJkYSBmdW5jdGlvblxuICovXG5leHBvcnQgdHlwZSBTc21FbnZWYXJzID0ge1xuICAvKipcbiAgICogVGhlIHJlY29yZCBrZXkgbmFtZXMgYXJlIHRoZSBicmFuY2gtc3BlY2lmaWMgU1NNIHBhdGhzIHRvIGZldGNoIHRoZSB2YWx1ZSBmcm9tXG4gICAqL1xuICBbYnJhbmNoUGF0aDogc3RyaW5nXToge1xuICAgIC8qKlxuICAgICAqIFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lIHRvIHBsYWNlIHRoZSByZXNvbHZlZCB2YWx1ZSBpblxuICAgICAqL1xuICAgIG5hbWU6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBBbiBvcHRpb25hbCBcImZhbGxiYWNrXCIgU1NNIHBhdGggd2hlcmUgdGhlIHZhbHVlIHdpbGwgYmUgbG9va2VkIHVwIGlmIG5vdCBmb3VuZCBhdCB0aGUgYnJhbmNoLXNwZWNpZmljIHBhdGhcbiAgICAgKi9cbiAgICBzaGFyZWRQYXRoPzogc3RyaW5nO1xuICB9O1xufTtcbiJdfQ==