import { AmplifyData } from '@aws-amplify/data-construct';
import * as path from 'path';
import { convertSchemaToCDK } from './convert_schema.js';
import { buildConstructFactoryFunctionInstanceProvider, convertFunctionNameMapToCDK, } from './convert_functions.js';
import { buildConstructFactoryProvidedAuthConfig, convertAuthorizationModesToCDK, isUsingDefaultApiKeyAuth, } from './convert_authorization_modes.js';
import { validateAuthorizationModes } from './validate_authorization_modes.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Singleton factory for AmplifyGraphqlApi constructs that can be used in Amplify project files
 */
class DataFactory {
    props;
    importStack;
    generator;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(props, importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
    }
    /**
     * Gets an instance of the Data construct
     */
    getInstance = (props) => {
        const { constructContainer, outputStorageStrategy, importPathVerifier } = props;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'data', 'resource'), 'Amplify Data must be defined in amplify/data/resource.ts');
        if (!this.generator) {
            this.generator = new DataGenerator(this.props, buildConstructFactoryProvidedAuthConfig(props.constructContainer
                .getConstructFactory('AuthResources')
                ?.getInstance(props)), buildConstructFactoryFunctionInstanceProvider(props), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class DataGenerator {
    props;
    providedAuthConfig;
    functionInstanceProvider;
    outputStorageStrategy;
    resourceGroupName = 'data';
    defaultName = 'amplifyData';
    constructor(props, providedAuthConfig, functionInstanceProvider, outputStorageStrategy) {
        this.props = props;
        this.providedAuthConfig = providedAuthConfig;
        this.functionInstanceProvider = functionInstanceProvider;
        this.outputStorageStrategy = outputStorageStrategy;
    }
    generateContainerEntry = (scope) => {
        let authorizationModes;
        try {
            authorizationModes = convertAuthorizationModesToCDK(this.functionInstanceProvider, this.providedAuthConfig, this.props.authorizationModes);
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Cannot covert authorization modes',
            }, error instanceof Error ? error : undefined);
        }
        try {
            validateAuthorizationModes(this.props.authorizationModes, authorizationModes);
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to validate authorization modes',
            }, error instanceof Error ? error : undefined);
        }
        const sandboxModeEnabled = isUsingDefaultApiKeyAuth(this.providedAuthConfig, this.props.authorizationModes);
        const functionNameMap = convertFunctionNameMapToCDK(this.functionInstanceProvider, this.props.functions ?? {});
        let amplifyGraphqlDefinition;
        try {
            amplifyGraphqlDefinition = convertSchemaToCDK(this.props.schema);
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaError', {
                message: error instanceof Error
                    ? error.message
                    : 'Cannot covert user schema',
            }, error instanceof Error ? error : undefined);
        }
        return new AmplifyData(scope, this.defaultName, {
            apiName: this.props.name,
            definition: amplifyGraphqlDefinition,
            authorizationModes,
            outputStorageStrategy: this.outputStorageStrategy,
            functionNameMap,
            translationBehavior: { sandboxModeEnabled },
        });
    };
}
/**
 * Creates a factory that implements ConstructFactory<AmplifyGraphqlApi>
 */
export const defineData = (props) => new DataFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUxRCxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUU3QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN6RCxPQUFPLEVBRUwsNkNBQTZDLEVBQzdDLDJCQUEyQixHQUM1QixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFFTCx1Q0FBdUMsRUFDdkMsOEJBQThCLEVBQzlCLHdCQUF3QixHQUN6QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTlEOztHQUVHO0FBQ0gsTUFBTSxXQUFXO0lBT0k7SUFDQTtJQVBYLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUFnQixFQUNoQixjQUFjLElBQUksS0FBSyxFQUFFLENBQUMsS0FBSztRQUQvQixVQUFLLEdBQUwsS0FBSyxDQUFXO1FBQ2hCLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtJQUMvQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxXQUFXLEdBQUcsQ0FBQyxLQUF1QyxFQUFlLEVBQUU7UUFDckUsTUFBTSxFQUFFLGtCQUFrQixFQUFFLHFCQUFxQixFQUFFLGtCQUFrQixFQUFFLEdBQ3JFLEtBQUssQ0FBQztRQUNSLGtCQUFrQixFQUFFLE1BQU0sQ0FDeEIsSUFBSSxDQUFDLFdBQVcsRUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxFQUN4QywwREFBMEQsQ0FDM0QsQ0FBQztRQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxF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QUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FDM0MsQ0FBQztTQUNIO1FBRUQsT0FBTyxJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUM5QyxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQ3hCLFVBQVUsRUFBRSx3QkFBd0I7WUFDcEMsa0JBQWtCO1lBQ2xCLHFCQUFxQixFQUFFLElBQUksQ0FBQyxxQkFBcUI7WUFDakQsZUFBZTtZQUNmLG1CQUFtQixFQUFFLEVBQUUsa0JBQWtCLEVBQUU7U0FDNUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0NBQ0g7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxDQUFDLEtBQWdCLEVBQWlDLEVBQUUsQ0FDNUUsSUFBSSxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgUmVzb3VyY2VQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RGF0YSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9kYXRhLWNvbnN0cnVjdCc7XG5pbXBvcnQgeyBHcmFwaHFsT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IERhdGFQcm9wcyB9IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgY29udmVydFNjaGVtYVRvQ0RLIH0gZnJvbSAnLi9jb252ZXJ0X3NjaGVtYS5qcyc7XG5pbXBvcnQge1xuICBGdW5jdGlvbkluc3RhbmNlUHJvdmlkZXIsXG4gIGJ1aWxkQ29uc3RydWN0RmFjdG9yeUZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcixcbiAgY29udmVydEZ1bmN0aW9uTmFtZU1hcFRvQ0RLLFxufSBmcm9tICcuL2NvbnZlcnRfZnVuY3Rpb25zLmpzJztcbmltcG9ydCB7XG4gIFByb3ZpZGVkQXV0aENvbmZpZyxcbiAgYnVpbGRDb25zdHJ1Y3RGYWN0b3J5UHJvdmlkZWRBdXRoQ29uZmlnLFxuICBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVzVG9DREssXG4gIGlzVXNpbmdEZWZhdWx0QXBpS2V5QXV0aCxcbn0gZnJvbSAnLi9jb252ZXJ0X2F1dGhvcml6YXRpb25fbW9kZXMuanMnO1xuaW1wb3J0IHsgdmFsaWRhdGVBdXRob3JpemF0aW9uTW9kZXMgfSBmcm9tICcuL3ZhbGlkYXRlX2F1dGhvcml6YXRpb25fbW9kZXMuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuLyoqXG4gKiBTaW5nbGV0b24gZmFjdG9yeSBmb3IgQW1wbGlmeUdyYXBocWxBcGkgY29uc3RydWN0cyB0aGF0IGNhbiBiZSB1c2VkIGluIEFtcGxpZnkgcHJvamVjdCBmaWxlc1xuICovXG5jbGFzcyBEYXRhRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeURhdGE+IHtcbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUNvbnN0cnVjdFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRGF0YVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaW1wb3J0U3RhY2sgPSBuZXcgRXJyb3IoKS5zdGFja1xuICApIHt9XG5cbiAgLyoqXG4gICAqIEdldHMgYW4gaW5zdGFuY2Ugb2YgdGhlIERhdGEgY29uc3RydWN0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9IChwcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMpOiBBbXBsaWZ5RGF0YSA9PiB7XG4gICAgY29uc3QgeyBjb25zdHJ1Y3RDb250YWluZXIsIG91dHB1dFN0b3JhZ2VTdHJhdGVneSwgaW1wb3J0UGF0aFZlcmlmaWVyIH0gPVxuICAgICAgcHJvcHM7XG4gICAgaW1wb3J0UGF0aFZlcmlmaWVyPy52ZXJpZnkoXG4gICAgICB0aGlzLmltcG9ydFN0YWNrLFxuICAgICAgcGF0aC5qb2luKCdhbXBsaWZ5JywgJ2RhdGEnLCAncmVzb3VyY2UnKSxcbiAgICAgICdBbXBsaWZ5IERhdGEgbXVzdCBiZSBkZWZpbmVkIGluIGFtcGxpZnkvZGF0YS9yZXNvdXJjZS50cydcbiAgICApO1xuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IERhdGFHZW5lcmF0b3IoXG4gICAgICAgIHRoaXMucHJvcHMsXG4gICAgICAgIGJ1aWxkQ29uc3RydWN0RmFjdG9yeVByb3ZpZGVkQXV0aENvbmZpZyhcbiAgICAgICAgICBwcm9wcy5jb25zdHJ1Y3RDb250YWluZXJcbiAgICAgICAgICAgIC5nZXRDb25zdHJ1Y3RGYWN0b3J5PFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz4+KFxuICAgICAgICAgICAgICAnQXV0aFJlc291cmNlcydcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgID8uZ2V0SW5zdGFuY2UocHJvcHMpXG4gICAgICAgICksXG4gICAgICAgIGJ1aWxkQ29uc3RydWN0RmFjdG9yeUZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcihwcm9wcyksXG4gICAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEFtcGxpZnlEYXRhO1xuICB9O1xufVxuXG5jbGFzcyBEYXRhR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZSA9ICdkYXRhJztcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0TmFtZSA9ICdhbXBsaWZ5RGF0YSc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRGF0YVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvdmlkZWRBdXRoQ29uZmlnOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkluc3RhbmNlUHJvdmlkZXI6IEZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxHcmFwaHFsT3V0cHV0PlxuICApIHt9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9IChzY29wZTogQ29uc3RydWN0KSA9PiB7XG4gICAgbGV0IGF1dGhvcml6YXRpb25Nb2RlcztcblxuICAgIHRyeSB7XG4gICAgICBhdXRob3JpemF0aW9uTW9kZXMgPSBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVzVG9DREsoXG4gICAgICAgIHRoaXMuZnVuY3Rpb25JbnN0YW5jZVByb3ZpZGVyLFxuICAgICAgICB0aGlzLnByb3ZpZGVkQXV0aENvbmZpZyxcbiAgICAgICAgdGhpcy5wcm9wcy5hdXRob3JpemF0aW9uTW9kZXNcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnSW52YWxpZFNjaGVtYUF1dGhFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgICAgICAgOiAnQ2Fubm90IGNvdmVydCBhdXRob3JpemF0aW9uIG1vZGVzJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUF1dGhvcml6YXRpb25Nb2RlcyhcbiAgICAgICAgdGhpcy5wcm9wcy5hdXRob3JpemF0aW9uTW9kZXMsXG4gICAgICAgIGF1dGhvcml6YXRpb25Nb2Rlc1xuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdJbnZhbGlkU2NoZW1hQXV0aEVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgICAgID8gZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgICA6ICdGYWlsZWQgdG8gdmFsaWRhdGUgYXV0aG9yaXphdGlvbiBtb2RlcycsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IHVuZGVmaW5lZFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzYW5kYm94TW9kZUVuYWJsZWQgPSBpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGgoXG4gICAgICB0aGlzLnByb3ZpZGVkQXV0aENvbmZpZyxcbiAgICAgIHRoaXMucHJvcHMuYXV0aG9yaXphdGlvbk1vZGVzXG4gICAgKTtcblxuICAgIGNvbnN0IGZ1bmN0aW9uTmFtZU1hcCA9IGNvbnZlcnRGdW5jdGlvbk5hbWVNYXBUb0NESyhcbiAgICAgIHRoaXMuZnVuY3Rpb25JbnN0YW5jZVByb3ZpZGVyLFxuICAgICAgdGhpcy5wcm9wcy5mdW5jdGlvbnMgPz8ge31cbiAgICApO1xuXG4gICAgbGV0IGFtcGxpZnlHcmFwaHFsRGVmaW5pdGlvbjtcbiAgICB0cnkge1xuICAgICAgYW1wbGlmeUdyYXBocWxEZWZpbml0aW9uID0gY29udmVydFNjaGVtYVRvQ0RLKHRoaXMucHJvcHMuc2NoZW1hKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdJbnZhbGlkU2NoZW1hRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogJ0Nhbm5vdCBjb3ZlcnQgdXNlciBzY2hlbWEnLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBBbXBsaWZ5RGF0YShzY29wZSwgdGhpcy5kZWZhdWx0TmFtZSwge1xuICAgICAgYXBpTmFtZTogdGhpcy5wcm9wcy5uYW1lLFxuICAgICAgZGVmaW5pdGlvbjogYW1wbGlmeUdyYXBocWxEZWZpbml0aW9uLFxuICAgICAgYXV0aG9yaXphdGlvbk1vZGVzLFxuICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgIGZ1bmN0aW9uTmFtZU1hcCxcbiAgICAgIHRyYW5zbGF0aW9uQmVoYXZpb3I6IHsgc2FuZGJveE1vZGVFbmFibGVkIH0sXG4gICAgfSk7XG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIGZhY3RvcnkgdGhhdCBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeUdyYXBocWxBcGk+XG4gKi9cbmV4cG9ydCBjb25zdCBkZWZpbmVEYXRhID0gKHByb3BzOiBEYXRhUHJvcHMpOiBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlEYXRhPiA9PlxuICBuZXcgRGF0YUZhY3RvcnkocHJvcHMsIG5ldyBFcnJvcigpLnN0YWNrKTtcbiJdfQ==