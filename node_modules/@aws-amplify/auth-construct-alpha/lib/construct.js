"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const string_maps_js_1 = require("./string_maps.js");
const util_arn_parser_1 = require("@aws-sdk/util-arn-parser");
const authProvidersList = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b;
        super(scope, id);
        /**
         * Attach a Lambda function trigger handler to the UserPool in this construct
         * @param event - The trigger event operation
         * @param handler - The function that will handle the event
         */
        this.addTrigger = (event, handler) => {
            if ('resources' in handler) {
                this.userPool.addTrigger(aws_cognito_1.UserPoolOperation.of(event), handler.resources.lambda);
            }
            else {
                // handler is an IFunction
                this.userPool.addTrigger(aws_cognito_1.UserPoolOperation.of(event), handler);
            }
        };
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oauthMappings;
            if (providerSetupResult.oidc) {
                identityPool.openIdConnectProviderArns = [
                    (0, util_arn_parser_1.build)({
                        service: 'iam',
                        region,
                        accountId: aws_cdk_lib_1.Stack.of(this).account,
                        resource: `oidc-provider/cognito-idp.${region}.amazonaws.com/${providerSetupResult.oidc.providerName}`,
                    }),
                ];
            }
            if (providerSetupResult.saml) {
                identityPool.samlProviderArns = [
                    (0, util_arn_parser_1.build)({
                        service: 'iam',
                        region,
                        accountId: aws_cdk_lib_1.Stack.of(this).account,
                        resource: `saml-provider/${providerSetupResult.saml.providerName}`,
                    }),
                ];
            }
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...(props.userAttributes ? props.userAttributes : {}),
                },
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: this.getMFAMode(props.multifactor),
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: typeof props.multifactor === 'object' &&
                    props.multifactor.mode !== 'OFF'
                    ? {
                        sms: props.multifactor.sms ? true : false,
                        otp: props.multifactor.totp ? true : false,
                    }
                    : undefined,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement type
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup Identity Providers (OAuth/OIDC/SAML)
         */
        this.setupIdentityProviders = (userPool, loginOptions) => {
            var _a, _b, _c, _d, _e;
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oauthMappings: {},
                providersList: [],
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: ((_a = googleProps.attributeMapping) !== null && _a !== void 0 ? _a : shouldMapEmailAttributes)
                        ? {
                            email: {
                                attributeName: 'email',
                            },
                        }
                        : undefined,
                    scopes: googleProps.scopes,
                });
                result.oauthMappings[authProvidersList.google] = external.google.clientId;
                result.providersList.push('GOOGLE');
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: ((_b = external.facebook.attributeMapping) !== null && _b !== void 0 ? _b : shouldMapEmailAttributes)
                        ? {
                            email: {
                                attributeName: 'email',
                            },
                        }
                        : undefined,
                });
                result.oauthMappings[authProvidersList.facebook] =
                    external.facebook.clientId;
                result.providersList.push('FACEBOOK');
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: ((_c = external.loginWithAmazon.attributeMapping) !== null && _c !== void 0 ? _c : shouldMapEmailAttributes)
                        ? {
                            email: {
                                attributeName: 'email',
                            },
                        }
                        : undefined,
                });
                result.oauthMappings[authProvidersList.amazon] =
                    external.loginWithAmazon.clientId;
                result.providersList.push('AMAZON');
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: ((_d = external.signInWithApple.attributeMapping) !== null && _d !== void 0 ? _d : shouldMapEmailAttributes)
                        ? {
                            email: {
                                attributeName: 'email',
                            },
                        }
                        : undefined,
                });
                result.oauthMappings[authProvidersList.apple] =
                    external.signInWithApple.clientId;
                result.providersList.push('APPLE');
            }
            if (external.oidc) {
                const oidc = external.oidc;
                const requestMethod = oidc.attributeRequestMethod === undefined
                    ? 'GET' // default if not defined
                    : oidc.attributeRequestMethod;
                result.oidc = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}OidcIDP`, {
                    userPool,
                    attributeRequestMethod: requestMethod === 'GET'
                        ? aws_cognito_1.OidcAttributeRequestMethod.GET
                        : aws_cognito_1.OidcAttributeRequestMethod.POST,
                    clientId: oidc.clientId,
                    clientSecret: oidc.clientSecret,
                    endpoints: oidc.endpoints,
                    identifiers: oidc.identifiers,
                    issuerUrl: oidc.issuerUrl,
                    name: oidc.name,
                    scopes: oidc.scopes,
                    attributeMapping: ((_e = oidc.attributeMapping) !== null && _e !== void 0 ? _e : shouldMapEmailAttributes)
                        ? {
                            email: {
                                attributeName: 'email',
                            },
                        }
                        : undefined,
                });
                result.providersList.push('OIDC');
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: saml.attributeMapping,
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
                result.providersList.push('SAML');
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            var _a, _b, _c, _d, _e;
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: this.resources.cfnResources.cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
                allowUnauthenticatedIdentities: this.resources.cfnResources.cfnIdentityPool
                    .allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            };
            if (this.computedUserPoolProps.standardAttributes) {
                const signupAttributes = Object.entries(this.computedUserPoolProps.standardAttributes).reduce((acc, [attributeName, attribute]) => {
                    if (attribute === null || attribute === void 0 ? void 0 : attribute.required) {
                        const treatedAttributeName = string_maps_js_1.coreAttributeNameMap.find(({ standardAttributeName }) => standardAttributeName === attributeName);
                        if (treatedAttributeName) {
                            return [
                                ...acc,
                                treatedAttributeName.userpoolAttributeName.toUpperCase(),
                            ];
                        }
                    }
                    return acc;
                }, []);
                output.signupAttributes = JSON.stringify(signupAttributes);
            }
            if (this.computedUserPoolProps.signInAliases) {
                const usernameAttributes = [];
                if (this.computedUserPoolProps.signInAliases.email) {
                    usernameAttributes.push('EMAIL');
                }
                if (this.computedUserPoolProps.signInAliases.phone) {
                    usernameAttributes.push('PHONE_NUMBER');
                }
                if (this.computedUserPoolProps.signInAliases.preferredUsername ||
                    this.computedUserPoolProps.signInAliases.username) {
                    usernameAttributes.push('PREFERRED_USERNAME');
                }
                if (usernameAttributes.length > 0) {
                    output.usernameAttributes = JSON.stringify(usernameAttributes);
                }
            }
            if (this.computedUserPoolProps.autoVerify) {
                const verificationMechanisms = [];
                if (this.computedUserPoolProps.autoVerify.email) {
                    verificationMechanisms.push('EMAIL');
                }
                if (this.computedUserPoolProps.autoVerify.phone) {
                    verificationMechanisms.push('PHONE');
                }
                if (verificationMechanisms.length > 0) {
                    output.verificationMechanisms = JSON.stringify(verificationMechanisms);
                }
            }
            if (this.computedUserPoolProps.passwordPolicy) {
                output.passwordPolicyMinLength =
                    (_a = this.computedUserPoolProps.passwordPolicy.minLength) === null || _a === void 0 ? void 0 : _a.toString();
                const requirements = [];
                if (this.computedUserPoolProps.passwordPolicy.requireDigits) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireLowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireUppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireSymbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                if (requirements.length > 0) {
                    output.passwordPolicyRequirements = JSON.stringify(requirements);
                }
            }
            if (this.computedUserPoolProps.mfa) {
                output.mfaConfiguration = this.computedUserPoolProps.mfa;
                const mfaTypes = [];
                if ((_b = this.computedUserPoolProps.mfaSecondFactor) === null || _b === void 0 ? void 0 : _b.otp) {
                    mfaTypes.push('TOTP');
                }
                if ((_c = this.computedUserPoolProps.mfaSecondFactor) === null || _c === void 0 ? void 0 : _c.sms) {
                    mfaTypes.push('SMS');
                }
                if (mfaTypes.length > 0) {
                    output.mfaTypes = JSON.stringify(mfaTypes);
                }
            }
            const oauthMappings = this.providerSetupResult.oauthMappings;
            if (oauthMappings[authProvidersList.amazon]) {
                output.amazonClientId = oauthMappings[authProvidersList.amazon];
            }
            if (oauthMappings[authProvidersList.facebook]) {
                output.facebookClientId = oauthMappings[authProvidersList.facebook];
            }
            if (oauthMappings[authProvidersList.google]) {
                output.googleClientId = oauthMappings[authProvidersList.google];
            }
            if (oauthMappings[authProvidersList.apple]) {
                output.appleClientId = oauthMappings[authProvidersList.apple];
            }
            if (this.providerSetupResult.providersList.length > 0) {
                output.socialProviders = JSON.stringify(this.providerSetupResult.providersList);
                // if any providers were defined, we must expose the oauth settings to the output
                if (this.oAuthSettings) {
                    if (this.domainPrefix) {
                        output.oauthDomain = `${this.domainPrefix}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                    }
                    output.oauthScope = JSON.stringify((_e = (_d = this.oAuthSettings.scopes) === null || _d === void 0 ? void 0 : _d.map((s) => s.scopeName)) !== null && _e !== void 0 ? _e : []);
                    output.oauthRedirectSignIn = this.oAuthSettings.callbackUrls
                        ? this.oAuthSettings.callbackUrls.join(',')
                        : '';
                    output.oauthRedirectSignOut = this.oAuthSettings.logoutUrls
                        ? this.oAuthSettings.logoutUrls.join(',')
                        : '';
                    output.oauthClientId = this.resources.userPoolClient.userPoolClientId;
                    output.oauthResponseType = 'code';
                }
            }
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        // UserPool - Identity Providers
        this.providerSetupResult = this.setupIdentityProviders(this.userPool, props.loginWith);
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        if (this.domainPrefix &&
            this.providerSetupResult.providersList.length > 0) {
            this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                cognitoDomain: { domainPrefix: this.domainPrefix },
            });
        }
        else if (this.domainPrefix &&
            this.providerSetupResult.providersList.length === 0) {
            throw new Error('You cannot configure a domain prefix if there are no external providers configured.');
        }
        // if oauth is enabled, prepare the oauth settings for the UserPool client
        const oauthEnabled = this.providerSetupResult.providersList.length > 0;
        const externalProviders = props.loginWith.externalProviders;
        if (oauthEnabled && externalProviders) {
            // make sure logout/callback urls are not empty
            if (externalProviders.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (externalProviders.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            this.oAuthSettings = {
                callbackUrls: externalProviders.callbackUrls,
                logoutUrls: externalProviders.logoutUrls,
                scopes: externalProviders.scopes
                    ? this.getOAuthScopes(externalProviders.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: {
                    authorizationCodeGrant: true,
                },
            };
        }
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.oAuthSettings,
        });
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            cfnResources: {
                cfnUserPool: this.userPool.node.findChild('Resource'),
                cfnUserPoolClient: userPoolClient.node.findChild('Resource'),
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            emailBody = emailSettings.verificationEmailBody(VERIFICATION_EMAIL_PLACEHOLDERS.LINK);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.LINK)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyw2Q0FBMkU7QUFPM0UseURBaUJpQztBQUNqQyxpREFBK0Q7QUFDL0QsZ0ZBQWdGO0FBT2hGLCtDQUF5QztBQUV6QyxnRkFHNkM7QUFDN0MsMkNBQTZCO0FBQzdCLHFEQUF3RDtBQUN4RCw4REFBK0Q7QUFhL0QsTUFBTSxpQkFBaUIsR0FBRztJQUN4QixRQUFRLEVBQUUsb0JBQW9CO0lBQzlCLE1BQU0sRUFBRSxxQkFBcUI7SUFDN0IsTUFBTSxFQUFFLGdCQUFnQjtJQUN4QixLQUFLLEVBQUUsbUJBQW1CO0NBQzNCLENBQUM7QUFDRixNQUFNLCtCQUErQixHQUFHO0lBQ3RDLElBQUksRUFBRSxRQUFRO0lBQ2QsSUFBSSxFQUFFLG9CQUFvQjtDQUMzQixDQUFDO0FBQ0YsTUFBTSw2QkFBNkIsR0FBRztJQUNwQyxJQUFJLEVBQUUsUUFBUTtDQUNmLENBQUM7QUFDRixNQUFNLG9CQUFvQixHQUFHO0lBQzNCLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0Isd0JBQVUsQ0FBQyxLQUFLO0lBQ2hCLHdCQUFVLENBQUMsS0FBSztJQUNoQix3QkFBVSxDQUFDLE1BQU07SUFDakIsd0JBQVUsQ0FBQyxPQUFPO0lBQ2xCLHdCQUFVLENBQUMsYUFBYTtDQUN6QixDQUFDO0FBRUYsc0hBQXNIO0FBQ3RILE1BQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQztBQUVyQzs7R0FFRztBQUNILE1BQWEsV0FDWCxTQUFRLHNCQUFTO0lBc0JqQjs7O09BR0c7SUFDSCxZQUNFLEtBQWdCLEVBQ2hCLEVBQVUsRUFDVixRQUFtQixzQkFBUSxDQUFDLG9CQUFvQjs7UUFFaEQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENB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LENBQUMsc0JBQXNCLEtBQUssTUFBTSxFQUMvQztZQUNBLFNBQVMsR0FBRyxhQUFhLENBQUMscUJBQXFCLENBQzdDLCtCQUErQixDQUFDLElBQUksQ0FDckMsQ0FBQztZQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3RCxNQUFNLEtBQUssQ0FDVCxzSkFBc0osQ0FDdkosQ0FBQzthQUNIO1NBQ0Y7UUFDRCxJQUNFLGFBQWEsQ0FBQyxxQkFBcUI7WUFDbkMsYUFBYSxDQUFDLHNCQUFzQixLQUFLLE1BQU0sRUFDL0M7WUFDQSxTQUFTLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixDQUM3QywrQkFBK0IsQ0FBQyxJQUFJLENBQ3JDLENBQUM7WUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQywrQkFBK0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0QsTUFBTSxLQUFLLENBQ1Qsc0pBQXNKLENBQ3ZKLENBQUM7YUFDSDtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQTZiRjtBQTcwQkQsa0NBNjBCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSwgU3RhY2ssIGF3c19jb2duaXRvIGFzIGNvZ25pdG8gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQge1xuICBBbXBsaWZ5RnVuY3Rpb24sXG4gIEF1dGhSZXNvdXJjZXMsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQ2ZuVXNlclBvb2wsXG4gIENmblVzZXJQb29sQ2xpZW50LFxuICBNZmEsXG4gIE9BdXRoU2NvcGUsXG4gIE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLFxuICBVc2VyUG9vbCxcbiAgVXNlclBvb2xDbGllbnQsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFtYXpvbixcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlck9pZGMsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWwsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUsXG4gIFVzZXJQb29sT3BlcmF0aW9uLFxuICBVc2VyUG9vbFByb3BzLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XG5pbXBvcnQgeyBGZWRlcmF0ZWRQcmluY2lwYWwsIFJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IEF1dGhPdXRwdXQsIGF1dGhPdXRwdXRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBBdXRoUHJvcHMsXG4gIEVtYWlsTG9naW5TZXR0aW5ncyxcbiAgRXh0ZXJuYWxQcm92aWRlck9wdGlvbnMsXG4gIFRyaWdnZXJFdmVudCxcbn0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBERUZBVUxUUyB9IGZyb20gJy4vZGVmYXVsdHMuanMnO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBjb3JlQXR0cmlidXRlTmFtZU1hcCB9IGZyb20gJy4vc3RyaW5nX21hcHMuanMnO1xuaW1wb3J0IHsgYnVpbGQgYXMgYXJuQnVpbGRlciB9IGZyb20gJ0Bhd3Mtc2RrL3V0aWwtYXJuLXBhcnNlcic7XG5cbnR5cGUgRGVmYXVsdFJvbGVzID0geyBhdXRoOiBSb2xlOyB1bkF1dGg6IFJvbGUgfTtcbnR5cGUgSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0ID0ge1xuICBvYXV0aE1hcHBpbmdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBwcm92aWRlcnNMaXN0OiBzdHJpbmdbXTtcbiAgZ29vZ2xlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyR29vZ2xlO1xuICBmYWNlYm9vaz86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rO1xuICBhbWF6b24/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b247XG4gIGFwcGxlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGU7XG4gIG9pZGM/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjO1xuICBzYW1sPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbDtcbn07XG5jb25zdCBhdXRoUHJvdmlkZXJzTGlzdCA9IHtcbiAgZmFjZWJvb2s6ICdncmFwaC5mYWNlYm9vay5jb20nLFxuICBnb29nbGU6ICdhY2NvdW50cy5nb29nbGUuY29tJyxcbiAgYW1hem9uOiAnd3d3LmFtYXpvbi5jb20nLFxuICBhcHBsZTogJ2FwcGxlaWQuYXBwbGUuY29tJyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgTElOSzogJ3sjI1ZlcmlmeSBFbWFpbCMjfScsXG59O1xuY29uc3QgVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IE1GQV9TTVNfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9Jyxcbn07XG5jb25zdCBERUZBVUxUX09BVVRIX1NDT1BFUyA9IFtcbiAgT0F1dGhTY29wZS5QSE9ORSxcbiAgT0F1dGhTY29wZS5FTUFJTCxcbiAgT0F1dGhTY29wZS5PUEVOSUQsXG4gIE9BdXRoU2NvcGUuUFJPRklMRSxcbiAgT0F1dGhTY29wZS5DT0dOSVRPX0FETUlOLFxuXTtcblxuLy8gQmUgdmVyeSBjYXJlZnVsIGVkaXRpbmcgdGhpcyB2YWx1ZS4gSXQgaXMgdGhlIHN0cmluZyB0aGF0IGlzIHVzZWQgdG8gYXR0cmlidXRlIHN0YWNrcyB0byBBbXBsaWZ5IEF1dGggaW4gQkkgbWV0cmljc1xuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIEFtcGxpZnkgQXV0aCBDREsgQ29uc3RydWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz5cbntcbiAgLyoqXG4gICAqIFRoZSByZXNvdXJjZXMgZ2VuZXJhdGVkIGJ5IHRoZSBjb25zdHJ1Y3QuXG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZXM6IEF1dGhSZXNvdXJjZXM7XG4gIC8qKlxuICAgKiBFeHRlcm5hbCBwcm92aWRlciBzZXR0aW5nc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlclNldHVwUmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB1c2VyUG9vbDogVXNlclBvb2w7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb21wdXRlZFVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHM7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkb21haW5QcmVmaXg6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IG9BdXRoU2V0dGluZ3M6IGNvZ25pdG8uT0F1dGhTZXR0aW5ncyB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEF1dGggY29uc3RydWN0IHdpdGggQXV0aFByb3BzLlxuICAgKiBJZiBubyBwcm9wcyBhcmUgcHJvdmlkZWQsIGVtYWlsIGxvZ2luIGFuZCBkZWZhdWx0cyB3aWxsIGJlIHVzZWQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEF1dGhQcm9wcyA9IERFRkFVTFRTLklGX05PX1BST1BTX1BST1ZJREVEXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICB0aGlzLm5hbWUgPSBwcm9wcy5uYW1lID8/ICcnO1xuXG4gICAgLy8gVXNlclBvb2xcbiAgICB0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcyA9IHRoaXMuZ2V0VXNlclBvb2xQcm9wcyhwcm9wcyk7XG4gICAgdGhpcy51c2VyUG9vbCA9IG5ldyBjb2duaXRvLlVzZXJQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1Vc2VyUG9vbGAsXG4gICAgICB0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wc1xuICAgICk7XG5cbiAgICAvLyBVc2VyUG9vbCAtIElkZW50aXR5IFByb3ZpZGVyc1xuICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdCA9IHRoaXMuc2V0dXBJZGVudGl0eVByb3ZpZGVycyhcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICBwcm9wcy5sb2dpbldpdGhcbiAgICApO1xuXG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcbiAgICBpZiAoXG4gICAgICB0aGlzLmRvbWFpblByZWZpeCAmJlxuICAgICAgdGhpcy5wcm92aWRlclNldHVwUmVzdWx0LnByb3ZpZGVyc0xpc3QubGVuZ3RoID4gMFxuICAgICkge1xuICAgICAgdGhpcy51c2VyUG9vbC5hZGREb21haW4oYCR7dGhpcy5uYW1lfVVzZXJQb29sRG9tYWluYCwge1xuICAgICAgICBjb2duaXRvRG9tYWluOiB7IGRvbWFpblByZWZpeDogdGhpcy5kb21haW5QcmVmaXggfSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0aGlzLmRvbWFpblByZWZpeCAmJlxuICAgICAgdGhpcy5wcm92aWRlclNldHVwUmVzdWx0LnByb3ZpZGVyc0xpc3QubGVuZ3RoID09PSAwXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdZb3UgY2Fubm90IGNvbmZpZ3VyZSBhIGRvbWFpbiBwcmVmaXggaWYgdGhlcmUgYXJlIG5vIGV4dGVybmFsIHByb3ZpZGVycyBjb25maWd1cmVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gaWYgb2F1dGggaXMgZW5hYmxlZCwgcHJlcGFyZSB0aGUgb2F1dGggc2V0dGluZ3MgZm9yIHRoZSBVc2VyUG9vbCBjbGllbnRcbiAgICBjb25zdCBvYXV0aEVuYWJsZWQgPSB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQucHJvdmlkZXJzTGlzdC5sZW5ndGggPiAwO1xuICAgIGNvbnN0IGV4dGVybmFsUHJvdmlkZXJzID0gcHJvcHMubG9naW5XaXRoLmV4dGVybmFsUHJvdmlkZXJzO1xuICAgIGlmIChvYXV0aEVuYWJsZWQgJiYgZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSBsb2dvdXQvY2FsbGJhY2sgdXJscyBhcmUgbm90IGVtcHR5XG4gICAgICBpZiAoZXh0ZXJuYWxQcm92aWRlcnMubG9nb3V0VXJscy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgJ1lvdSBtdXN0IGRlZmluZSBsb2dvdXRVcmxzIHdoZW4gY29uZmlndXJpbmcgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChleHRlcm5hbFByb3ZpZGVycy5jYWxsYmFja1VybHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgICdZb3UgbXVzdCBkZWZpbmUgY2FsbGJhY2tVcmxzIHdoZW4gY29uZmlndXJpbmcgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMub0F1dGhTZXR0aW5ncyA9IHtcbiAgICAgICAgY2FsbGJhY2tVcmxzOiBleHRlcm5hbFByb3ZpZGVycy5jYWxsYmFja1VybHMsXG4gICAgICAgIGxvZ291dFVybHM6IGV4dGVybmFsUHJvdmlkZXJzLmxvZ291dFVybHMsXG4gICAgICAgIHNjb3BlczogZXh0ZXJuYWxQcm92aWRlcnMuc2NvcGVzXG4gICAgICAgICAgPyB0aGlzLmdldE9BdXRoU2NvcGVzKGV4dGVybmFsUHJvdmlkZXJzLnNjb3BlcylcbiAgICAgICAgICA6IERFRkFVTFRfT0FVVEhfU0NPUEVTLFxuICAgICAgICBmbG93czoge1xuICAgICAgICAgIGF1dGhvcml6YXRpb25Db2RlR3JhbnQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH1cbiAgICAvLyBVc2VyUG9vbCBDbGllbnRcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IG5ldyBjb2duaXRvLlVzZXJQb29sQ2xpZW50KFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1Vc2VyUG9vbEFwcENsaWVudGAsXG4gICAgICB7XG4gICAgICAgIHVzZXJQb29sOiB0aGlzLnVzZXJQb29sLFxuICAgICAgICBhdXRoRmxvd3M6IERFRkFVTFRTLkFVVEhfRkxPV1MsXG4gICAgICAgIHByZXZlbnRVc2VyRXhpc3RlbmNlRXJyb3JzOiBERUZBVUxUUy5QUkVWRU5UX1VTRVJfRVhJU1RFTkNFX0VSUk9SUyxcbiAgICAgICAgb0F1dGg6IHRoaXMub0F1dGhTZXR0aW5ncyxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gSWRlbnRpdHkgUG9vbFxuICAgIGNvbnN0IHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXM6IHsgYXV0aCwgdW5BdXRoIH0sXG4gICAgfSA9IHRoaXMuc2V0dXBJZGVudGl0eVBvb2woXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHRcbiAgICApO1xuXG4gICAgLy8gZXhwb3NlIHJlc291cmNlc1xuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgdXNlclBvb2w6IHRoaXMudXNlclBvb2wsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogYXV0aCxcbiAgICAgIHVuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlOiB1bkF1dGgsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuVXNlclBvb2w6IHRoaXMudXNlclBvb2wubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuVXNlclBvb2wsXG4gICAgICAgIGNmblVzZXJQb29sQ2xpZW50OiB1c2VyUG9vbENsaWVudC5ub2RlLmZpbmRDaGlsZChcbiAgICAgICAgICAnUmVzb3VyY2UnXG4gICAgICAgICkgYXMgQ2ZuVXNlclBvb2xDbGllbnQsXG4gICAgICAgIGNmbklkZW50aXR5UG9vbDogaWRlbnRpdHlQb29sLFxuICAgICAgICBjZm5JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudDogaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICB9LFxuICAgIH07XG4gICAgdGhpcy5zdG9yZU91dHB1dChwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBhdXRoU3RhY2tUeXBlLFxuICAgICAgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3BhY2thZ2UuanNvbicpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2ggYSBMYW1iZGEgZnVuY3Rpb24gdHJpZ2dlciBoYW5kbGVyIHRvIHRoZSBVc2VyUG9vbCBpbiB0aGlzIGNvbnN0cnVjdFxuICAgKiBAcGFyYW0gZXZlbnQgLSBUaGUgdHJpZ2dlciBldmVudCBvcGVyYXRpb25cbiAgICogQHBhcmFtIGhhbmRsZXIgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGhhbmRsZSB0aGUgZXZlbnRcbiAgICovXG4gIGFkZFRyaWdnZXIgPSAoXG4gICAgZXZlbnQ6IFRyaWdnZXJFdmVudCxcbiAgICBoYW5kbGVyOiBJRnVuY3Rpb24gfCBBbXBsaWZ5RnVuY3Rpb25cbiAgKTogdm9pZCA9PiB7XG4gICAgaWYgKCdyZXNvdXJjZXMnIGluIGhhbmRsZXIpIHtcbiAgICAgIHRoaXMudXNlclBvb2wuYWRkVHJpZ2dlcihcbiAgICAgICAgVXNlclBvb2xPcGVyYXRpb24ub2YoZXZlbnQpLFxuICAgICAgICBoYW5kbGVyLnJlc291cmNlcy5sYW1iZGFcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGhhbmRsZXIgaXMgYW4gSUZ1bmN0aW9uXG4gICAgICB0aGlzLnVzZXJQb29sLmFkZFRyaWdnZXIoVXNlclBvb2xPcGVyYXRpb24ub2YoZXZlbnQpLCBoYW5kbGVyKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBBdXRoL1VuQXV0aCBSb2xlc1xuICAgKiBAcmV0dXJucyBEZWZhdWx0Um9sZXNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMgPSAoaWRlbnRpdHlQb29sSWQ6IHN0cmluZyk6IERlZmF1bHRSb2xlcyA9PiB7XG4gICAgY29uc3QgcmVzdWx0OiBEZWZhdWx0Um9sZXMgPSB7XG4gICAgICBhdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9YXV0aGVudGljYXRlZFVzZXJSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSdcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICAgdW5BdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9dW5hdXRoZW50aWNhdGVkVXNlclJvbGVgLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IEZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWQnOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAndW5hdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHVwIElkZW50aXR5IFBvb2wgd2l0aCBkZWZhdWx0IHJvbGVzL3JvbGUgbWFwcGluZ3MsIGFuZCByZWdpc3RlciBwcm92aWRlcnNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBJZGVudGl0eVBvb2wgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sLFxuICAgIHVzZXJQb29sQ2xpZW50OiBVc2VyUG9vbENsaWVudCxcbiAgICBwcm92aWRlclNldHVwUmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHRcbiAgKSA9PiB7XG4gICAgLy8gc2V0dXAgaWRlbnRpdHkgcG9vbFxuICAgIGNvbnN0IHJlZ2lvbiA9IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbjtcbiAgICBjb25zdCBpZGVudGl0eVBvb2wgPSBuZXcgY29nbml0by5DZm5JZGVudGl0eVBvb2woXG4gICAgICB0aGlzLFxuICAgICAgYCR7dGhpcy5uYW1lfUlkZW50aXR5UG9vbGAsXG4gICAgICB7XG4gICAgICAgIGFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllczpcbiAgICAgICAgICBERUZBVUxUUy5BTExPV19VTkFVVEhFTlRJQ0FURURfSURFTlRJVElFUyxcbiAgICAgIH1cbiAgICApO1xuICAgIGNvbnN0IHJvbGVzID0gdGhpcy5zZXR1cEF1dGhBbmRVbkF1dGhSb2xlcyhpZGVudGl0eVBvb2wucmVmKTtcbiAgICBjb25zdCBpZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudCA9XG4gICAgICBuZXcgY29nbml0by5DZm5JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50YCxcbiAgICAgICAge1xuICAgICAgICAgIGlkZW50aXR5UG9vbElkOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIHJvbGVzOiB7XG4gICAgICAgICAgICB1bmF1dGhlbnRpY2F0ZWQ6IHJvbGVzLnVuQXV0aC5yb2xlQXJuLFxuICAgICAgICAgICAgYXV0aGVudGljYXRlZDogcm9sZXMuYXV0aC5yb2xlQXJuLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcm9sZU1hcHBpbmdzOiB7XG4gICAgICAgICAgICBVc2VyUG9vbFdlYkNsaWVudFJvbGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAgIHR5cGU6ICdUb2tlbicsXG4gICAgICAgICAgICAgIGFtYmlndW91c1JvbGVSZXNvbHV0aW9uOiAnQXV0aGVudGljYXRlZFJvbGUnLFxuICAgICAgICAgICAgICBpZGVudGl0eVByb3ZpZGVyOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfToke3VzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWR9YCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICBpZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudC5hZGREZXBlbmRlbmN5KGlkZW50aXR5UG9vbCk7XG4gICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQubm9kZS5hZGREZXBlbmRlbmN5KHVzZXJQb29sQ2xpZW50KTtcbiAgICAvLyBhZGQgY29nbml0byBwcm92aWRlclxuICAgIGlkZW50aXR5UG9vbC5jb2duaXRvSWRlbnRpdHlQcm92aWRlcnMgPSBbXG4gICAgICB7XG4gICAgICAgIGNsaWVudElkOiB1c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgICBwcm92aWRlck5hbWU6IGBjb2duaXRvLWlkcC4ke3JlZ2lvbn0uYW1hem9uYXdzLmNvbS8ke3VzZXJQb29sLnVzZXJQb29sSWR9YCxcbiAgICAgIH0sXG4gICAgXTtcbiAgICAvLyBhZGQgb3RoZXIgcHJvdmlkZXJzXG4gICAgaWRlbnRpdHlQb29sLnN1cHBvcnRlZExvZ2luUHJvdmlkZXJzID0gcHJvdmlkZXJTZXR1cFJlc3VsdC5vYXV0aE1hcHBpbmdzO1xuICAgIGlmIChwcm92aWRlclNldHVwUmVzdWx0Lm9pZGMpIHtcbiAgICAgIGlkZW50aXR5UG9vbC5vcGVuSWRDb25uZWN0UHJvdmlkZXJBcm5zID0gW1xuICAgICAgICBhcm5CdWlsZGVyKHtcbiAgICAgICAgICBzZXJ2aWNlOiAnaWFtJyxcbiAgICAgICAgICByZWdpb24sXG4gICAgICAgICAgYWNjb3VudElkOiBTdGFjay5vZih0aGlzKS5hY2NvdW50LFxuICAgICAgICAgIHJlc291cmNlOiBgb2lkYy1wcm92aWRlci9jb2duaXRvLWlkcC4ke3JlZ2lvbn0uYW1hem9uYXdzLmNvbS8ke3Byb3ZpZGVyU2V0dXBSZXN1bHQub2lkYy5wcm92aWRlck5hbWV9YCxcbiAgICAgICAgfSksXG4gICAgICBdO1xuICAgIH1cbiAgICBpZiAocHJvdmlkZXJTZXR1cFJlc3VsdC5zYW1sKSB7XG4gICAgICBpZGVudGl0eVBvb2wuc2FtbFByb3ZpZGVyQXJucyA9IFtcbiAgICAgICAgYXJuQnVpbGRlcih7XG4gICAgICAgICAgc2VydmljZTogJ2lhbScsXG4gICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgIGFjY291bnRJZDogU3RhY2sub2YodGhpcykuYWNjb3VudCxcbiAgICAgICAgICByZXNvdXJjZTogYHNhbWwtcHJvdmlkZXIvJHtwcm92aWRlclNldHVwUmVzdWx0LnNhbWwucHJvdmlkZXJOYW1lfWAsXG4gICAgICAgIH0pLFxuICAgICAgXTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogUHJvY2VzcyBwcm9wcyBpbnRvIFVzZXJQb29sUHJvcHMgKHNldCBkZWZhdWx0cyBpZiBuZWVkZWQpXG4gICAqL1xuICBwcml2YXRlIGdldFVzZXJQb29sUHJvcHMgPSAocHJvcHM6IEF1dGhQcm9wcyk6IFVzZXJQb29sUHJvcHMgPT4ge1xuICAgIGNvbnN0IGVtYWlsRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC5lbWFpbCA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCBwaG9uZUVuYWJsZWQgPSBwcm9wcy5sb2dpbldpdGgucGhvbmUgPyB0cnVlIDogZmFsc2U7XG4gICAgY29uc3Qgb25lT2ZFbWFpbE9yUGhvbmUgPSBlbWFpbEVuYWJsZWQgfHwgcGhvbmVFbmFibGVkO1xuICAgIGlmICghb25lT2ZFbWFpbE9yUGhvbmUpIHtcbiAgICAgIHRocm93IEVycm9yKCdBdCBsZWFzdCBvbmUgb2YgZW1haWwgb3IgcGhvbmUgbXVzdCBiZSBlbmFibGVkLicpO1xuICAgIH1cbiAgICBsZXQgdXNlclZlcmlmaWNhdGlvblNldHRpbmdzOiBjb2duaXRvLlVzZXJWZXJpZmljYXRpb25Db25maWcgPSB7fTtcbiAgICAvLyBleHRyYWN0IGVtYWlsIHNldHRpbmdzIGlmIHNldHRpbmdzIG9iamVjdCBpcyBkZWZpbmVkXG4gICAgaWYgKHR5cGVvZiBwcm9wcy5sb2dpbldpdGguZW1haWwgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBlbWFpbFNldHRpbmdzID0gcHJvcHMubG9naW5XaXRoLmVtYWlsO1xuICAgICAgLy8gdmVyaWZ5IGVtYWlsIGJvZHkgYW5kIGluamVjdCB0aGUgYWN0dWFsIHRlbXBsYXRlIHZhbHVlcyB3aGljaCBjb2duaXRvIHVzZXNcbiAgICAgIGNvbnN0IGVtYWlsQm9keTogc3RyaW5nIHwgdW5kZWZpbmVkID0gdGhpcy52ZXJpZnlFbWFpbEJvZHkoZW1haWxTZXR0aW5ncyk7XG4gICAgICB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MgPSB7XG4gICAgICAgIGVtYWlsQm9keTogZW1haWxCb2R5LFxuICAgICAgICBlbWFpbFN0eWxlOiB0aGlzLmdldEVtYWlsVmVyaWZpY2F0aW9uU3R5bGUoXG4gICAgICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN0eWxlXG4gICAgICAgICksXG4gICAgICAgIGVtYWlsU3ViamVjdDogZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN1YmplY3QsXG4gICAgICB9O1xuICAgIH1cbiAgICAvLyBleHRyYWN0IHBob25lIHNldHRpbmdzIGlmIHNldHRpbmdzIG9iamVjdCBpcyBkZWZpbmVkXG4gICAgaWYgKHR5cGVvZiBwcm9wcy5sb2dpbldpdGgucGhvbmUgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBwaG9uZVNldHRpbmdzID0gcHJvcHMubG9naW5XaXRoLnBob25lO1xuICAgICAgbGV0IHNtc01lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChcbiAgICAgICAgcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlICYmXG4gICAgICAgIHR5cGVvZiBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UgPT09ICdmdW5jdGlvbidcbiAgICAgICkge1xuICAgICAgICAvLyB2YWxpZGF0ZSBzbXMgbWVzc2FnZSBzdHJ1Y3R1cmVcbiAgICAgICAgc21zTWVzc2FnZSA9IHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZShcbiAgICAgICAgICBWRVJJRklDQVRJT05fU01TX1BMQUNFSE9MREVSUy5DT0RFXG4gICAgICAgICk7XG4gICAgICAgIGlmICghc21zTWVzc2FnZS5pbmNsdWRlcyhWRVJJRklDQVRJT05fU01TX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgICAgXCJJbnZhbGlkIHBob25lIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uTWVzc2FnZScgbXVzdCB1dGlsaXplIHRoZSAnY29kZScgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBjb2RlLlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdXNlclZlcmlmaWNhdGlvblNldHRpbmdzID0ge1xuICAgICAgICAuLi51c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MsXG4gICAgICAgIHNtc01lc3NhZ2U6IHNtc01lc3NhZ2UsXG4gICAgICB9O1xuICAgIH1cbiAgICBjb25zdCB1c2VyUG9vbFByb3BzOiBVc2VyUG9vbFByb3BzID0ge1xuICAgICAgc2lnbkluQ2FzZVNlbnNpdGl2ZTogREVGQVVMVFMuU0lHTl9JTl9DQVNFX1NFTlNJVElWRSxcbiAgICAgIHNpZ25JbkFsaWFzZXM6IHtcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBrZWVwT3JpZ2luYWw6IHtcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBhdXRvVmVyaWZ5OiB7XG4gICAgICAgIGVtYWlsOiBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lOiBwaG9uZUVuYWJsZWQsXG4gICAgICB9LFxuICAgICAgdXNlclZlcmlmaWNhdGlvbjogdXNlclZlcmlmaWNhdGlvblNldHRpbmdzLFxuICAgICAgcGFzc3dvcmRQb2xpY3k6IERFRkFVTFRTLlBBU1NXT1JEX1BPTElDWSxcbiAgICAgIHN0YW5kYXJkQXR0cmlidXRlczoge1xuICAgICAgICBlbWFpbDogREVGQVVMVFMuSVNfUkVRVUlSRURfQVRUUklCVVRFLmVtYWlsKGVtYWlsRW5hYmxlZCksXG4gICAgICAgIHBob25lTnVtYmVyOiBERUZBVUxUUy5JU19SRVFVSVJFRF9BVFRSSUJVVEUucGhvbmVOdW1iZXIocGhvbmVFbmFibGVkKSxcbiAgICAgICAgLi4uKHByb3BzLnVzZXJBdHRyaWJ1dGVzID8gcHJvcHMudXNlckF0dHJpYnV0ZXMgOiB7fSksXG4gICAgICB9LFxuICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IERFRkFVTFRTLkFMTE9XX1NFTEZfU0lHTl9VUCxcbiAgICAgIG1mYTogdGhpcy5nZXRNRkFNb2RlKHByb3BzLm11bHRpZmFjdG9yKSxcbiAgICAgIG1mYU1lc3NhZ2U6IHRoaXMuZ2V0TUZBTWVzc2FnZShwcm9wcy5tdWx0aWZhY3RvciksXG4gICAgICBtZmFTZWNvbmRGYWN0b3I6XG4gICAgICAgIHR5cGVvZiBwcm9wcy5tdWx0aWZhY3RvciA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgcHJvcHMubXVsdGlmYWN0b3IubW9kZSAhPT0gJ09GRidcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgc21zOiBwcm9wcy5tdWx0aWZhY3Rvci5zbXMgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgICAgICAgIG90cDogcHJvcHMubXVsdGlmYWN0b3IudG90cCA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIGFjY291bnRSZWNvdmVyeTogdGhpcy5nZXRBY2NvdW50UmVjb3ZlcnlTZXR0aW5nKFxuICAgICAgICBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lRW5hYmxlZCxcbiAgICAgICAgcHJvcHMuYWNjb3VudFJlY292ZXJ5XG4gICAgICApLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH07XG4gICAgcmV0dXJuIHVzZXJQb29sUHJvcHM7XG4gIH07XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB0aGUgZW1haWwgYm9keSBkZXBlbmRpbmcgb24gaWYgJ0NPREUnIG9yICdMSU5LJyBzdHlsZSBpcyB1c2VkLlxuICAgKiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgdGVtcGxhdGUgY29udGFpbnMgdGhlIG5lY2Vzc2FyeSBwbGFjZWhvbGRlcnMgZm9yIENvZ25pdG8gdG8gaW5zZXJ0IHZlcmlmaWNhdGlvbiBjb2RlcyBvciBsaW5rcy5cbiAgICogQHBhcmFtIGVtYWlsU2V0dGluZ3MgdGhlIHByb3ZpZGVkIGVtYWlsIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGVtYWlsQm9keVxuICAgKi9cbiAgcHJpdmF0ZSB2ZXJpZnlFbWFpbEJvZHkoXG4gICAgZW1haWxTZXR0aW5nczogRW1haWxMb2dpblNldHRpbmdzXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IGVtYWlsQm9keTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmIChcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5ICYmXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgIT09ICdMSU5LJ1xuICAgICkge1xuICAgICAgZW1haWxCb2R5ID0gZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkoXG4gICAgICAgIFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuQ09ERVxuICAgICAgKTtcbiAgICAgIGlmICghZW1haWxCb2R5LmluY2x1ZGVzKFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIGVtYWlsIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uRW1haWxCb2R5JyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKFxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkgJiZcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0xJTksnXG4gICAgKSB7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keShcbiAgICAgICAgVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5MSU5LXG4gICAgICApO1xuICAgICAgaWYgKCFlbWFpbEJvZHkuaW5jbHVkZXMoVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5MSU5LKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgZW1haWwgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25FbWFpbEJvZHknIG11c3QgdXRpbGl6ZSB0aGUgJ2xpbmsnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gbGluay5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZW1haWxCb2R5O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBlbWFpbCB2ZXJpZmljYXRpb24gc3R5bGUgZnJvbSB1c2VyIHByb3BzXG4gICAqIEBwYXJhbSB2ZXJpZmljYXRpb25FbWFpbFN0eWxlIC0gc3RyaW5nIHZhbHVlXG4gICAqIEByZXR1cm5zIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgLSBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGdldEVtYWlsVmVyaWZpY2F0aW9uU3R5bGUgPSAoXG4gICAgdmVyaWZpY2F0aW9uRW1haWxTdHlsZTogJ0NPREUnIHwgJ0xJTksnIHwgdW5kZWZpbmVkXG4gICk6IGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdDT0RFJykge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZS5DT0RFO1xuICAgIH0gZWxzZSBpZiAodmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0xJTksnKSB7XG4gICAgICByZXR1cm4gY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlLkxJTks7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIERldGVybWluZSB0aGUgYWNjb3VudCByZWNvdmVyeSBvcHRpb24gYmFzZWQgb24gZW5hYmxlZCBsb2dpbiBtZXRob2RzLlxuICAgKiBAcGFyYW0gZW1haWxFbmFibGVkIC0gaXMgZW1haWwgZW5hYmxlZFxuICAgKiBAcGFyYW0gcGhvbmVFbmFibGVkIC0gaXMgcGhvbmUgZW5hYmxlZFxuICAgKiBAcGFyYW0gYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmcgLSB0aGUgdXNlciBwcm92aWRlZCBhY2NvdW50IHJlY292ZXJ5IHNldHRpbmdcbiAgICogQHJldHVybnMgYWNjb3VudCByZWNvdmVyeSBzZXR0aW5nIGVudW0gdmFsdWVcbiAgICovXG4gIHByaXZhdGUgZ2V0QWNjb3VudFJlY292ZXJ5U2V0dGluZyA9IChcbiAgICBlbWFpbEVuYWJsZWQ6IGJvb2xlYW4sXG4gICAgcGhvbmVFbmFibGVkOiBib29sZWFuLFxuICAgIGFjY291bnRSZWNvdmVyeU1ldGhvZEFzU3RyaW5nOiBBdXRoUHJvcHNbJ2FjY291bnRSZWNvdmVyeSddXG4gICk6IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IHwgdW5kZWZpbmVkID0+IHtcbiAgICBjb25zdCBhY2NvdW50UmVjb3ZlcnkgPSB0aGlzLmNvbnZlcnRBY2NvdW50UmVjb3ZlcnlTdHJpbmdUb0VudW0oXG4gICAgICBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZ1xuICAgICk7XG4gICAgaWYgKGFjY291bnRSZWNvdmVyeSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gYWNjb3VudFJlY292ZXJ5O1xuICAgIH1cbiAgICAvLyBzZXQgZGVmYXVsdCBiYXNlZCBvbiBlbmFibGVkIGxvZ2luIG1ldGhvZHNcbiAgICBpZiAocGhvbmVFbmFibGVkICYmIGVtYWlsRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LkVNQUlMX09OTFk7XG4gICAgfVxuICAgIGlmIChwaG9uZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5QSE9ORV9PTkxZX1dJVEhPVVRfTUZBO1xuICAgIH1cbiAgICBpZiAoZW1haWxFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuRU1BSUxfT05MWTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydCB1c2VyIGZyaWVuZGx5IE1mYSBtb2RlIHRvIGNvZ25pdG8gTWZhIHR5cGUuXG4gICAqIFRoaXMgZWxpbWluYXRlcyB0aGUgbmVlZCBmb3IgdXNlcnMgdG8gaW1wb3J0IGNvZ25pdG8uTWZhLlxuICAgKiBAcGFyYW0gbWZhIC0gTUZBIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGNvZ25pdG8gTUZBIGVuZm9yY2VtZW50IHR5cGVcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBTW9kZSA9IChtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXSk6IE1mYSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1mYSkge1xuICAgICAgc3dpdGNoIChtZmEubW9kZSkge1xuICAgICAgICBjYXNlICdPRkYnOlxuICAgICAgICAgIHJldHVybiBNZmEuT0ZGO1xuICAgICAgICBjYXNlICdPUFRJT05BTCc6XG4gICAgICAgICAgcmV0dXJuIE1mYS5PUFRJT05BTDtcbiAgICAgICAgY2FzZSAnUkVRVUlSRUQnOlxuICAgICAgICAgIHJldHVybiBNZmEuUkVRVUlSRUQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBhY2NvdW50IHJlY292ZXJ5IG1ldGhvZCB0byBjb2duaXRvIEFjY291bnRSZWNvdmVyIGVudW0uXG4gICAqIFRoaXMgZWxpbWluYXRlcyB0aGUgbmVlZCBmb3IgdXNlcnMgdG8gaW1wb3J0IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LlxuICAgKiBAcGFyYW0gbWV0aG9kIC0gYWNjb3VudCByZWNvdmVyeSBtZXRob2QgYXMgYSBzdHJpbmcgdmFsdWVcbiAgICogQHJldHVybnMgY29nbml0by5BY2NvdW50UmVjb3ZlcnkgZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0QWNjb3VudFJlY292ZXJ5U3RyaW5nVG9FbnVtID0gKFxuICAgIG1ldGhvZDogQXV0aFByb3BzWydhY2NvdW50UmVjb3ZlcnknXVxuICApOiBjb2duaXRvLkFjY291bnRSZWNvdmVyeSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1ldGhvZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnlbbWV0aG9kXTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogRXh0cmFjdCB0aGUgTUZBIG1lc3NhZ2Ugc2V0dGluZ3MgYW5kIHBlcmZvcm0gdmFsaWRhdGlvbi5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBtZmEgbWVzc2FnZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRNRkFNZXNzYWdlID0gKFxuICAgIG1mYTogQXV0aFByb3BzWydtdWx0aWZhY3RvciddXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1mYSAmJiBtZmEubW9kZSAhPT0gJ09GRicgJiYgdHlwZW9mIG1mYS5zbXMgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gbWZhLnNtcy5zbXNNZXNzYWdlKE1GQV9TTVNfUExBQ0VIT0xERVJTLkNPREUpO1xuICAgICAgaWYgKCFtZXNzYWdlLmluY2x1ZGVzKE1GQV9TTVNfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgIFwiSW52YWxpZCBNRkEgc2V0dGluZ3MuIFByb3BlcnR5ICdzbXNNZXNzYWdlJyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBJZGVudGl0eSBQcm92aWRlcnMgKE9BdXRoL09JREMvU0FNTClcbiAgICovXG4gIHByaXZhdGUgc2V0dXBJZGVudGl0eVByb3ZpZGVycyA9IChcbiAgICB1c2VyUG9vbDogVXNlclBvb2wsXG4gICAgbG9naW5PcHRpb25zOiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddXG4gICk6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9PiB7XG4gICAgLyoqXG4gICAgICogSWYgZW1haWwgaXMgZW5hYmxlZCwgYW5kIGlzIHRoZSBvbmx5IHJlcXVpcmVkIGF0dHJpYnV0ZSwgd2UgYXJlIGFibGUgdG9cbiAgICAgKiBhdXRvbWF0aWNhbGx5IG1hcCB0aGUgZW1haWwgYXR0cmlidXRlIGZyb20gZXh0ZXJuYWwgcHJvdmlkZXJzLCBleGNsdWRpbmcgU0FNTC5cbiAgICAgKi9cbiAgICBjb25zdCBzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXMgPSBsb2dpbk9wdGlvbnMuZW1haWwgJiYgIWxvZ2luT3B0aW9ucy5waG9uZTtcbiAgICBjb25zdCByZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9IHtcbiAgICAgIG9hdXRoTWFwcGluZ3M6IHt9LFxuICAgICAgcHJvdmlkZXJzTGlzdDogW10sXG4gICAgfTtcbiAgICAvLyBleHRlcm5hbCBwcm92aWRlcnNcbiAgICBjb25zdCBleHRlcm5hbCA9IGxvZ2luT3B0aW9ucy5leHRlcm5hbFByb3ZpZGVycztcbiAgICBpZiAoIWV4dGVybmFsKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuZ29vZ2xlKSB7XG4gICAgICBjb25zdCBnb29nbGVQcm9wcyA9IGV4dGVybmFsLmdvb2dsZTtcbiAgICAgIHJlc3VsdC5nb29nbGUgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1Hb29nbGVJZFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgY2xpZW50SWQ6IGdvb2dsZVByb3BzLmNsaWVudElkLFxuICAgICAgICAgIGNsaWVudFNlY3JldFZhbHVlOiBnb29nbGVQcm9wcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzpcbiAgICAgICAgICAgIGdvb2dsZVByb3BzLmF0dHJpYnV0ZU1hcHBpbmcgPz8gc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IHtcbiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICBzY29wZXM6IGdvb2dsZVByb3BzLnNjb3BlcyxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0Lmdvb2dsZV0gPSBleHRlcm5hbC5nb29nbGUuY2xpZW50SWQ7XG4gICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKCdHT09HTEUnKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmZhY2Vib29rKSB7XG4gICAgICByZXN1bHQuZmFjZWJvb2sgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJGYWNlYm9vayhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUZhY2Vib29rSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmZhY2Vib29rLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6XG4gICAgICAgICAgICBleHRlcm5hbC5mYWNlYm9vay5hdHRyaWJ1dGVNYXBwaW5nID8/IHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB7XG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWU6ICdlbWFpbCcsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub2F1dGhNYXBwaW5nc1thdXRoUHJvdmlkZXJzTGlzdC5mYWNlYm9va10gPVxuICAgICAgICBleHRlcm5hbC5mYWNlYm9vay5jbGllbnRJZDtcbiAgICAgIHJlc3VsdC5wcm92aWRlcnNMaXN0LnB1c2goJ0ZBQ0VCT09LJyk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5sb2dpbldpdGhBbWF6b24pIHtcbiAgICAgIHJlc3VsdC5hbWF6b24gPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1BbWF6b25JRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6XG4gICAgICAgICAgICBleHRlcm5hbC5sb2dpbldpdGhBbWF6b24uYXR0cmlidXRlTWFwcGluZyA/P1xuICAgICAgICAgICAgc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IHtcbiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFtYXpvbl0gPVxuICAgICAgICBleHRlcm5hbC5sb2dpbldpdGhBbWF6b24uY2xpZW50SWQ7XG4gICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKCdBTUFaT04nKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLnNpZ25JbldpdGhBcHBsZSkge1xuICAgICAgcmVzdWx0LmFwcGxlID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGUoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1BcHBsZUlEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAuLi5leHRlcm5hbC5zaWduSW5XaXRoQXBwbGUsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzpcbiAgICAgICAgICAgIGV4dGVybmFsLnNpZ25JbldpdGhBcHBsZS5hdHRyaWJ1dGVNYXBwaW5nID8/XG4gICAgICAgICAgICBzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDoge1xuICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiAnZW1haWwnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9hdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuYXBwbGVdID1cbiAgICAgICAgZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLmNsaWVudElkO1xuICAgICAgcmVzdWx0LnByb3ZpZGVyc0xpc3QucHVzaCgnQVBQTEUnKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLm9pZGMpIHtcbiAgICAgIGNvbnN0IG9pZGMgPSBleHRlcm5hbC5vaWRjO1xuICAgICAgY29uc3QgcmVxdWVzdE1ldGhvZCA9XG4gICAgICAgIG9pZGMuYXR0cmlidXRlUmVxdWVzdE1ldGhvZCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgPyAnR0VUJyAvLyBkZWZhdWx0IGlmIG5vdCBkZWZpbmVkXG4gICAgICAgICAgOiBvaWRjLmF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q7XG4gICAgICByZXN1bHQub2lkYyA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlck9pZGMoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1PaWRjSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIGF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q6XG4gICAgICAgICAgICByZXF1ZXN0TWV0aG9kID09PSAnR0VUJ1xuICAgICAgICAgICAgICA/IE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLkdFVFxuICAgICAgICAgICAgICA6IE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLlBPU1QsXG4gICAgICAgICAgY2xpZW50SWQ6IG9pZGMuY2xpZW50SWQsXG4gICAgICAgICAgY2xpZW50U2VjcmV0OiBvaWRjLmNsaWVudFNlY3JldCxcbiAgICAgICAgICBlbmRwb2ludHM6IG9pZGMuZW5kcG9pbnRzLFxuICAgICAgICAgIGlkZW50aWZpZXJzOiBvaWRjLmlkZW50aWZpZXJzLFxuICAgICAgICAgIGlzc3VlclVybDogb2lkYy5pc3N1ZXJVcmwsXG4gICAgICAgICAgbmFtZTogb2lkYy5uYW1lLFxuICAgICAgICAgIHNjb3Blczogb2lkYy5zY29wZXMsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzpcbiAgICAgICAgICAgIG9pZGMuYXR0cmlidXRlTWFwcGluZyA/PyBzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDoge1xuICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiAnZW1haWwnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0LnByb3ZpZGVyc0xpc3QucHVzaCgnT0lEQycpO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuc2FtbCkge1xuICAgICAgY29uc3Qgc2FtbCA9IGV4dGVybmFsLnNhbWw7XG4gICAgICByZXN1bHQuc2FtbCA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWwoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1TYW1sSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHNhbWwuYXR0cmlidXRlTWFwcGluZyxcbiAgICAgICAgICBpZGVudGlmaWVyczogc2FtbC5pZGVudGlmaWVycyxcbiAgICAgICAgICBpZHBTaWdub3V0OiBzYW1sLmlkcFNpZ25vdXQsXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIG1ldGFkYXRhQ29udGVudDogc2FtbC5tZXRhZGF0YS5tZXRhZGF0YUNvbnRlbnQsXG4gICAgICAgICAgICBtZXRhZGF0YVR5cGU6XG4gICAgICAgICAgICAgIHNhbWwubWV0YWRhdGEubWV0YWRhdGFUeXBlID09PSAnRklMRSdcbiAgICAgICAgICAgICAgICA/IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUuRklMRVxuICAgICAgICAgICAgICAgIDogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZS5VUkwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBuYW1lOiBzYW1sLm5hbWUsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKCdTQU1MJyk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgc2NvcGVzIGZyb20gc3RyaW5nIGxpc3QgdG8gT0F1dGhTY29wZXMuXG4gICAqIEBwYXJhbSBzY29wZXMgLSBzY29wZSBsaXN0XG4gICAqIEByZXR1cm5zIGNvZ25pdG8gT0F1dGhTY29wZXNcbiAgICovXG4gIHByaXZhdGUgZ2V0T0F1dGhTY29wZXMgPSAoXG4gICAgc2NvcGVzOiBFeHRlcm5hbFByb3ZpZGVyT3B0aW9uc1snc2NvcGVzJ11cbiAgKTogY29nbml0by5PQXV0aFNjb3BlW10gPT4ge1xuICAgIGlmIChzY29wZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQ6IGNvZ25pdG8uT0F1dGhTY29wZVtdID0gW107XG4gICAgZm9yIChjb25zdCBzY29wZSBvZiBzY29wZXMpIHtcbiAgICAgIHJlc3VsdC5wdXNoKGNvZ25pdG8uT0F1dGhTY29wZVtzY29wZV0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBTdG9yZXMgYXV0aCBvdXRwdXQgdXNpbmcgdGhlIHByb3ZpZGVkIHN0cmF0ZWd5XG4gICAqL1xuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxBdXRoT3V0cHV0PiA9IG5ldyBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneShcbiAgICAgIFN0YWNrLm9mKHRoaXMpXG4gICAgKVxuICApOiB2b2lkID0+IHtcbiAgICBjb25zdCBvdXRwdXQ6IEF1dGhPdXRwdXRbJ3BheWxvYWQnXSA9IHtcbiAgICAgIHVzZXJQb29sSWQ6IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLnVzZXJQb29sSWQsXG4gICAgICB3ZWJDbGllbnRJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgIGlkZW50aXR5UG9vbElkOiB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuSWRlbnRpdHlQb29sLnJlZixcbiAgICAgIGF1dGhSZWdpb246IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbixcbiAgICAgIGFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllczpcbiAgICAgICAgdGhpcy5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmbklkZW50aXR5UG9vbFxuICAgICAgICAgIC5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPT09IHRydWVcbiAgICAgICAgICA/ICd0cnVlJ1xuICAgICAgICAgIDogJ2ZhbHNlJyxcbiAgICB9O1xuICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5zdGFuZGFyZEF0dHJpYnV0ZXMpIHtcbiAgICAgIGNvbnN0IHNpZ251cEF0dHJpYnV0ZXMgPSBPYmplY3QuZW50cmllcyhcbiAgICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMuc3RhbmRhcmRBdHRyaWJ1dGVzXG4gICAgICApLnJlZHVjZSgoYWNjOiBzdHJpbmdbXSwgW2F0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZV0pID0+IHtcbiAgICAgICAgaWYgKGF0dHJpYnV0ZT8ucmVxdWlyZWQpIHtcbiAgICAgICAgICBjb25zdCB0cmVhdGVkQXR0cmlidXRlTmFtZSA9IGNvcmVBdHRyaWJ1dGVOYW1lTWFwLmZpbmQoXG4gICAgICAgICAgICAoeyBzdGFuZGFyZEF0dHJpYnV0ZU5hbWUgfSkgPT5cbiAgICAgICAgICAgICAgc3RhbmRhcmRBdHRyaWJ1dGVOYW1lID09PSBhdHRyaWJ1dGVOYW1lXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmICh0cmVhdGVkQXR0cmlidXRlTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgLi4uYWNjLFxuICAgICAgICAgICAgICB0cmVhdGVkQXR0cmlidXRlTmFtZS51c2VycG9vbEF0dHJpYnV0ZU5hbWUudG9VcHBlckNhc2UoKSxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSk7XG4gICAgICBvdXRwdXQuc2lnbnVwQXR0cmlidXRlcyA9IEpTT04uc3RyaW5naWZ5KHNpZ251cEF0dHJpYnV0ZXMpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5zaWduSW5BbGlhc2VzKSB7XG4gICAgICBjb25zdCB1c2VybmFtZUF0dHJpYnV0ZXMgPSBbXTtcbiAgICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5zaWduSW5BbGlhc2VzLmVtYWlsKSB7XG4gICAgICAgIHVzZXJuYW1lQXR0cmlidXRlcy5wdXNoKCdFTUFJTCcpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnNpZ25JbkFsaWFzZXMucGhvbmUpIHtcbiAgICAgICAgdXNlcm5hbWVBdHRyaWJ1dGVzLnB1c2goJ1BIT05FX05VTUJFUicpO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICB0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5zaWduSW5BbGlhc2VzLnByZWZlcnJlZFVzZXJuYW1lIHx8XG4gICAgICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnNpZ25JbkFsaWFzZXMudXNlcm5hbWVcbiAgICAgICkge1xuICAgICAgICB1c2VybmFtZUF0dHJpYnV0ZXMucHVzaCgnUFJFRkVSUkVEX1VTRVJOQU1FJyk7XG4gICAgICB9XG4gICAgICBpZiAodXNlcm5hbWVBdHRyaWJ1dGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgb3V0cHV0LnVzZXJuYW1lQXR0cmlidXRlcyA9IEpTT04uc3RyaW5naWZ5KHVzZXJuYW1lQXR0cmlidXRlcyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLmF1dG9WZXJpZnkpIHtcbiAgICAgIGNvbnN0IHZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgPSBbXTtcbiAgICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5hdXRvVmVyaWZ5LmVtYWlsKSB7XG4gICAgICAgIHZlcmlmaWNhdGlvbk1lY2hhbmlzbXMucHVzaCgnRU1BSUwnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5hdXRvVmVyaWZ5LnBob25lKSB7XG4gICAgICAgIHZlcmlmaWNhdGlvbk1lY2hhbmlzbXMucHVzaCgnUEhPTkUnKTtcbiAgICAgIH1cbiAgICAgIGlmICh2ZXJpZmljYXRpb25NZWNoYW5pc21zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgb3V0cHV0LnZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgPSBKU09OLnN0cmluZ2lmeSh2ZXJpZmljYXRpb25NZWNoYW5pc21zKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMucGFzc3dvcmRQb2xpY3kpIHtcbiAgICAgIG91dHB1dC5wYXNzd29yZFBvbGljeU1pbkxlbmd0aCA9XG4gICAgICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5Lm1pbkxlbmd0aD8udG9TdHJpbmcoKTtcblxuICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gW107XG4gICAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMucGFzc3dvcmRQb2xpY3kucmVxdWlyZURpZ2l0cykge1xuICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTlVNQkVSUycpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVMb3dlcmNhc2UpIHtcbiAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVVcHBlcmNhc2UpIHtcbiAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVTeW1ib2xzKSB7XG4gICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19TWU1CT0xTJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXF1aXJlbWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICBvdXRwdXQucGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHMgPSBKU09OLnN0cmluZ2lmeShyZXF1aXJlbWVudHMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5tZmEpIHtcbiAgICAgIG91dHB1dC5tZmFDb25maWd1cmF0aW9uID0gdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMubWZhO1xuXG4gICAgICBjb25zdCBtZmFUeXBlcyA9IFtdO1xuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLm1mYVNlY29uZEZhY3Rvcj8ub3RwKSB7XG4gICAgICAgIG1mYVR5cGVzLnB1c2goJ1RPVFAnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5tZmFTZWNvbmRGYWN0b3I/LnNtcykge1xuICAgICAgICBtZmFUeXBlcy5wdXNoKCdTTVMnKTtcbiAgICAgIH1cbiAgICAgIGlmIChtZmFUeXBlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIG91dHB1dC5tZmFUeXBlcyA9IEpTT04uc3RyaW5naWZ5KG1mYVR5cGVzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgb2F1dGhNYXBwaW5ncyA9IHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdC5vYXV0aE1hcHBpbmdzO1xuICAgIGlmIChvYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFtYXpvbl0pIHtcbiAgICAgIG91dHB1dC5hbWF6b25DbGllbnRJZCA9IG9hdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuYW1hem9uXTtcbiAgICB9XG4gICAgaWYgKG9hdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuZmFjZWJvb2tdKSB7XG4gICAgICBvdXRwdXQuZmFjZWJvb2tDbGllbnRJZCA9IG9hdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuZmFjZWJvb2tdO1xuICAgIH1cbiAgICBpZiAob2F1dGhNYXBwaW5nc1thdXRoUHJvdmlkZXJzTGlzdC5nb29nbGVdKSB7XG4gICAgICBvdXRwdXQuZ29vZ2xlQ2xpZW50SWQgPSBvYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0Lmdvb2dsZV07XG4gICAgfVxuICAgIGlmIChvYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFwcGxlXSkge1xuICAgICAgb3V0cHV0LmFwcGxlQ2xpZW50SWQgPSBvYXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFwcGxlXTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm92aWRlclNldHVwUmVzdWx0LnByb3ZpZGVyc0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgb3V0cHV0LnNvY2lhbFByb3ZpZGVycyA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQucHJvdmlkZXJzTGlzdFxuICAgICAgKTtcbiAgICAgIC8vIGlmIGFueSBwcm92aWRlcnMgd2VyZSBkZWZpbmVkLCB3ZSBtdXN0IGV4cG9zZSB0aGUgb2F1dGggc2V0dGluZ3MgdG8gdGhlIG91dHB1dFxuICAgICAgaWYgKHRoaXMub0F1dGhTZXR0aW5ncykge1xuICAgICAgICBpZiAodGhpcy5kb21haW5QcmVmaXgpIHtcbiAgICAgICAgICBvdXRwdXQub2F1dGhEb21haW4gPSBgJHt0aGlzLmRvbWFpblByZWZpeH0uYXV0aC4ke1xuICAgICAgICAgICAgU3RhY2sub2YodGhpcykucmVnaW9uXG4gICAgICAgICAgfS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQub2F1dGhTY29wZSA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIHRoaXMub0F1dGhTZXR0aW5ncy5zY29wZXM/Lm1hcCgocykgPT4gcy5zY29wZU5hbWUpID8/IFtdXG4gICAgICAgICk7XG4gICAgICAgIG91dHB1dC5vYXV0aFJlZGlyZWN0U2lnbkluID0gdGhpcy5vQXV0aFNldHRpbmdzLmNhbGxiYWNrVXJsc1xuICAgICAgICAgID8gdGhpcy5vQXV0aFNldHRpbmdzLmNhbGxiYWNrVXJscy5qb2luKCcsJylcbiAgICAgICAgICA6ICcnO1xuICAgICAgICBvdXRwdXQub2F1dGhSZWRpcmVjdFNpZ25PdXQgPSB0aGlzLm9BdXRoU2V0dGluZ3MubG9nb3V0VXJsc1xuICAgICAgICAgID8gdGhpcy5vQXV0aFNldHRpbmdzLmxvZ291dFVybHMuam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgICAgb3V0cHV0Lm9hdXRoQ2xpZW50SWQgPSB0aGlzLnJlc291cmNlcy51c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkO1xuICAgICAgICBvdXRwdXQub2F1dGhSZXNwb25zZVR5cGUgPSAnY29kZSc7XG4gICAgICB9XG4gICAgfVxuXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFkZEJhY2tlbmRPdXRwdXRFbnRyeShhdXRoT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiBvdXRwdXQsXG4gICAgfSk7XG4gIH07XG59XG4iXX0=